# Системные паттерны

## Архитектура системы
Приложение построено как menubar-приложение для macOS. Основная логика разделена между `AppDelegate` (управление UI строки меню, окном настроек, уведомлениями) и `FolderMonitor` (отслеживание файлов, SFTP-загрузка).

## Ключевые технические решения
*   **Гибридное приложение (Menubar + Dock):** Приложение работает в основном из строки меню, но предоставляет опциональную иконку в доке для дополнительной функциональности (Drag & Drop).
*   **Управление состоянием приложения:** Динамическое изменение `NSApplication.ActivationPolicy` между `.accessory` (фоновый режим) и `.regular` (обычное приложение) для управления видимостью и поведением иконки в доке.
*   **Отслеживание папок:** Используется `DispatchSourceFileSystemObject` для эффективного мониторинга изменений в файловой системе.
*   **SFTP-клиент:** Для SFTP-загрузки используется сторонняя библиотека `mft` (Swift SFTP Client Framework), которая является оберткой над `libssh` и `OpenSSL`.
*   **Уведомления:** Используется `UserNotifications.framework` для системных уведомлений.
*   **Настройки:** `UserDefaults` используется для сохранения настроек пользователя (путь к папке, состояние уведомлений, автозапуск отслеживания).
*   **Автозапуск при старте системы:** Используется `SMLoginItemSetEnabled` из `ServiceManagement.framework` для управления автозапуском.
*   **App Sandbox:** Приложение работает в "песочнице" macOS, требуя явных разрешений для доступа к файлам пользователя и сетевым соединениям.
*   **Окно настроек с вкладками:** Для организации настроек используется `NSTabView`.
*   **Автозапуск (macOS 13.0+):** Обновлено для использования `SMAppService` из `ServiceManagement.framework`.

## Взаимосвязи компонентов
*   `AppDelegate` создает и управляет `NSStatusItem`, `NSMenu`, `SettingsWindowController`.
*   `AppDelegate` подписывается на уведомления от `FolderMonitor` для обновления статуса меню и отправки системных уведомлений.
*   `FolderMonitor` является синглтоном, доступным из `AppDelegate` и `SettingsViewController`.
*   `SettingsViewController` взаимодействует с `FolderMonitor` для получения/установки пути к папке и с `UserDefaults` для других настроек.
*   `SettingsViewController` использует `LaunchAtLoginManager` для управления автозапуском.
*   `LaunchAtLoginManager` использует `ServiceManagement.framework` для управления элементом входа.

## Критические пути реализации
*   **Инициализация:** При запуске `AppDelegate` устанавливает `NSApplication.ActivationPolicy` в зависимости от настроек пользователя, инициализирует `FolderMonitor` и проверяет папки.
*   **Отслеживание и загрузка:** `FolderMonitor` отслеживает папку, при обнаружении нового файла инициирует SFTP-загрузку, перемещает файл и отправляет уведомления.
*   **Загрузка через Dock:** Пользователь может перетащить файлы на иконку в доке. `AppDelegate` перехватывает это событие, запускает загрузку и анимацию. После завершения загрузки, если иконка в доке должна быть скрыта, `AppDelegate` программно возвращает приложение в состояние `.accessory`.
*   **Настройки:** Окно настроек позволяет пользователю изменить путь к папке, настроить уведомления, автозапуск и видимость иконки в доке, сохраняя изменения в `UserDefaults` и обновляя состояние приложения.
